@using Friday.ERP.Client.Data
@using Friday.ERP.Shared.DataTransferObjects
@inject IHttpRepository HttpRepo
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_success" @bind-Errors="@_errors">
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText=@(IsCustomer ? "ဈေးဝယ်သူကုဒ်" : "ဈေးရောင်းသူကုဒ်")
                                     SecondText="@Code"/>
                <CustomLabelAndLabel FirstText="အမည်"
                                     SecondText="@Name"/>
            </MudGrid>
            <MudGrid Spacing="2">
                <CustomLabelAndStringField FirstText="ဖုန်း" @bind-BindValue="@Phone" KeyboardInputType="InputType.Telephone"/>
                <CustomLabelAndStringField FirstText="အီးမေးလ်" @bind-BindValue="@Email" KeyboardInputType="InputType.Email"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndStringField FirstText="နေရပ်" @bind-BindValue="@Address"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLongField FirstText="အကြွေး/ပိုငွေ (ကျပ်)" @bind-BindValue="@TotalCreditDebit"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <CustomButton
            Label="ထွက်မည်" IsLoading="_isLoading" OnClick="@DialogCancel" Color="Color.Default" Variant="Variant.Text" FullWidth="false"/>
        <CustomButton
            Label="ပြောင်းမည်" IsLoading="_isLoading" OnClick="@DialogSubmit" Variant="Variant.Text" FullWidth="false"/>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public bool IsCustomer { get; set; }
    [Parameter] public Guid Guid { get; set; }
    [Parameter] public string? Code { get; set; }
    [Parameter] public string? Name { get; set; }
    [Parameter] public string? Phone { get; set; }
    [Parameter] public string? Email { get; set; }
    [Parameter] public string? Address { get; set; }
    [Parameter] public long TotalCreditDebit { get; set; }

    MudForm? _form;
    bool _success;
    string[] _errors = [];

    bool _isLoading;

    void DialogCancel()
    {
        MudDialog!.Cancel();
    }

    async Task DialogSubmit()
    {
        _isLoading = true;
        StateHasChanged();

        await _form!.Validate();

        if (_form.IsValid)
        {
            var dataToUpdate = new CustomerVendorUpdateDto(
                Phone,
                Email,
                Address,
                TotalCreditDebit
            );

            var httpResult = IsCustomer
                ? await HttpRepo.UpdateCustomer(Guid, dataToUpdate)
                : await HttpRepo.UpdateVendor(Guid, dataToUpdate);

            if (httpResult.isSuccess)
            {
                Snackbar.Add(IsCustomer ? "ဈေးဝယ်သူ၏ကိုယ်ရေးအချက်အလက်ကို ပြောင်းပြီးပါပြီ" : "ဈေးရောင်းသူ၏ကိုယ်ရေးအချက်အလက်ကို ပြောင်းပြီးပါပြီ", Severity.Success);
            }

            MudDialog!.Close(DialogResult.Ok(httpResult.isSuccess));
        }

        _isLoading = false;
        StateHasChanged();
    }

}