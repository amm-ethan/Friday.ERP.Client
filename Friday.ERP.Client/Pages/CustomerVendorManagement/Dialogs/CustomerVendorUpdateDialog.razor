@using Friday.ERP.Client.Data
@using Friday.ERP.Shared.DataTransferObjects
@inject IHttpRepository HttpRepo
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_success" @bind-Errors="@_errors">
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText=@(IsCustomer ? "Customer Code" : "Vendor Code")
                                        SecondText="@Code">
                </CustomLabelAndLabel>
                <CustomLabelAndLabel FirstText=@(IsCustomer ? "Customer Name" : "Vendor Name")
                                        SecondText="@Name">
                </CustomLabelAndLabel>
            </MudGrid>
            <MudGrid Spacing="2">
                <CustomLabelAndStringField FirstText="Phone" @bind-BindValue="@Phone" KeyboardInputType="InputType.Telephone"/>
                <CustomLabelAndStringField FirstText="Email" @bind-BindValue="@Email" KeyboardInputType="InputType.Email"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"></MudDivider>
            <MudGrid Spacing="2">
                <CustomLabelAndStringField FirstText="Address" @bind-BindValue="@Address"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"></MudDivider>
            <MudGrid Spacing="2">
                <CustomLabelAndLongField FirstText="Total Credit / Debit" @bind-BindValue="@TotalCreditDebit"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"></MudDivider>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <CustomButton
            Label="Cancel" IsLoading="_isLoading" OnClick="@DialogCancel" Color="Color.Default" Variant="Variant.Text" FullWidth="false"/>
        <CustomButton
            Label="Update" IsLoading="_isLoading" OnClick="@DialogSubmit" Variant="Variant.Text" FullWidth="false"/>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public bool IsCustomer { get; set; }
    [Parameter] public Guid Guid { get; set; }
    [Parameter] public string? Code { get; set; }
    [Parameter] public string? Name { get; set; }
    [Parameter] public string? Phone { get; set; }
    [Parameter] public string? Email { get; set; }
    [Parameter] public string? Address { get; set; }
    [Parameter] public long TotalCreditDebit { get; set; }

    MudForm? _form;
    bool _success;
    string[] _errors = [];

    bool _isLoading;

    void DialogCancel()
    {
        MudDialog!.Cancel();
    }

    async Task DialogSubmit()
    {
        _isLoading = true;
        StateHasChanged();

        await _form!.Validate();

        if (_form.IsValid)
        {
            var dataToUpdate = new CustomerVendorUpdateDto(
                Phone,
                Email,
                Address,
                TotalCreditDebit
            );

            var httpResult = IsCustomer
                ? await HttpRepo.UpdateCustomer(Guid, dataToUpdate)
                : await HttpRepo.UpdateVendor(Guid, dataToUpdate);

            if (httpResult.isSuccess)
            {
                Snackbar.Add(IsCustomer ? "Customer Created!" : "Vendor Created!", Severity.Success);
            }

            MudDialog!.Close(DialogResult.Ok(httpResult.isSuccess));
        }

        _isLoading = false;
        StateHasChanged();
    }

}