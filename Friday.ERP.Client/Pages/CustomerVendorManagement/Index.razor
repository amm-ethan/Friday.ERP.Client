@page "/cv-management"
@using Friday.ERP.Shared.DataTransferObjects
@using Friday.ERP.Shared.RequestFeatures
@using Friday.ERP.Client.Data
@using Friday.ERP.Client.Pages.CustomerVendorManagement.Dialogs
@using Friday.ERP.Client.Pages.UserManagement.Components
@using Friday.ERP.Client.Shared.Layouts
@inject IHttpRepository HttpRepo
@inject IDialogService DialogService

@layout MainLayout
@attribute [Authorize]

<CustomContainer>
    <CustomPage Sm="12" Md="12" IsLoading="@_isMainLoading">
        <MudTabs Elevation="0" Rounded="true" Centered="true">
            <CustomTab TitleText="စျေးဝယ်သူများ"
                       IsLoading="@_isLoading"
                       OnTabClick="@(() => ChangeTab(true))">
                <CustomHeader>
                    <MudItem sm="6" md="5" Class="align-self-center">
                        <CustomTextFieldWithIcon BindValue="@_searchTerm" ValueChanged="ChangeSearchValue" ClassParameter="mr-2"/>
                    </MudItem>
                    <MudItem sm="6" md="3" Class="align-self-center">
                        <CustomButton
                            Label="အသစ်ဖန်တီးရန်"
                            IsLoading="_isLoading"
                            OnClick="@OpenCustomerVendorCreateDialog"
                            Variant="Variant.Filled"/>
                    </MudItem>
                </CustomHeader>
                <CustomBody>
                    <MudItem sm="12">
                        @if (_customerVendorList.Count == 0)
                        {
                            <div class="d-flex d-column justify-center flex-grow-1" style="height: 54vh;">
                                <div class="align-self-center">
                                    <MudText Typo="Typo.caption">စျေးဝယ်သူမရှိသေးပါ</MudText>
                                </div>
                            </div>
                        }
                        else
                        {
                            <MudTable Elevation="0" Items="@_customerVendorList" RowsPerPage="10" Hover="true"
                                      Breakpoint="Breakpoint.Md" HorizontalScrollbar="true" LoadingProgressColor="Color.Info"
                                      FixedHeader="true" Height="54vh">
                                <HeaderContent>
                                    <MudTh>ကုဒ်</MudTh>
                                    <MudTh>အမည်</MudTh>
                                    <MudTh>ဖုန်း</MudTh>
                                    <MudTh>အီးမေးလ်</MudTh>
                                    <MudTh>နေရပ်</MudTh>
                                    <MudTh>ကျန်ငွေ/ပိုငွေ</MudTh>
                                    <MudTh>Action</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Name">@context.Code</MudTd>
                                    <MudTd DataLabel="Name">@context.Name</MudTd>
                                    <MudTd DataLabel="Phone">@(context.Phone ?? "N/A")</MudTd>
                                    <MudTd DataLabel="Email">@(context.Email ?? "N/A")</MudTd>
                                    <MudTd DataLabel="Address">@context.Address</MudTd>
                                    <MudTd DataLabel="Total Credit Debit Left">@context.TotalCreditDebitLeft</MudTd>
                                    <MudTd DataLabel="Action">
                                        <CustomButton
                                            Label="ပြောင်းရန်"
                                            IsLoading="_isLoading" FullWidth="false"
                                            OnClick="@(() => OpenCustomerVendorUpdateDialog(context))"/>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <div class="d-flex justify-center">
                                        <MudPagination ShowNextButton="true" ShowPreviousButton="true" SelectedChanged="ChangePage" Count="@_metaData.TotalPages" Class="pa-4"/>
                                    </div>
                                </PagerContent>
                            </MudTable>
                        }
                    </MudItem>
                </CustomBody>
            </CustomTab>
            <CustomTab TitleText="စျေးရောင်းသူများ"
                       IsLoading="@_isLoading"
                       OnTabClick="@(() => ChangeTab(false))">
                <CustomHeader>
                    <MudItem sm="6" md="5" Class="align-self-center">
                        <CustomTextFieldWithIcon BindValue="@_searchTerm" ValueChanged="ChangeSearchValue" ClassParameter="mr-2"/>
                    </MudItem>
                    <MudItem sm="6" md="3" Class="align-self-center">
                        <CustomButton
                            Label="အသစ်ဖန်တီးရန်"
                            IsLoading="_isLoading"
                            OnClick="@OpenCustomerVendorCreateDialog"
                            Variant="Variant.Filled"/>
                    </MudItem>
                </CustomHeader>
                <CustomBody>
                    <MudItem sm="12">
                        @if (_customerVendorList.Count == 0)
                        {
                            <div class="d-flex d-column justify-center flex-grow-1" style="height: 54vh;">
                                <div class="align-self-center">
                                    <MudText Typo="Typo.caption">စျေးရောင်းသူမရှိသေးပါ</MudText>
                                </div>
                            </div>
                        }
                        else
                        {
                            <MudTable Elevation="0" Items="@_customerVendorList" RowsPerPage="10" Hover="true"
                                      Breakpoint="Breakpoint.Md" HorizontalScrollbar="true" LoadingProgressColor="Color.Info"
                                      FixedHeader="true" Height="54vh">
                                <HeaderContent>
                                    <MudTh>ကုဒ်</MudTh>
                                    <MudTh>အမည်</MudTh>
                                    <MudTh>ဖုန်း</MudTh>
                                    <MudTh>အီးမေးလ်</MudTh>
                                    <MudTh>နေရပ်</MudTh>
                                    <MudTh>ကျန်ငွေ/ပိုငွေ</MudTh>
                                    <MudTh>Action</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Name">@context.Code</MudTd>
                                    <MudTd DataLabel="Name">@context.Name</MudTd>
                                    <MudTd DataLabel="Phone">@(context.Phone ?? "N/A")</MudTd>
                                    <MudTd DataLabel="Email">@(context.Email ?? "N/A")</MudTd>
                                    <MudTd DataLabel="Address">@context.Address</MudTd>
                                    <MudTd DataLabel="Total Credit Debit Left">@context.TotalCreditDebitLeft</MudTd>
                                    <MudTd DataLabel="Action">
                                        <CustomButton
                                            Label="ပြောင်းရန်"
                                            IsLoading="_isLoading" FullWidth="false"
                                            OnClick="@(() => OpenCustomerVendorUpdateDialog(context))"/>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <div class="d-flex justify-center">
                                        <MudPagination ShowNextButton="true" ShowPreviousButton="true" SelectedChanged="ChangePage" Count="@_metaData.TotalPages" Class="pa-4"/>
                                    </div>
                                </PagerContent>
                            </MudTable>
                        }
                    </MudItem>
                </CustomBody>
            </CustomTab>
        </MudTabs>
    </CustomPage>
</CustomContainer>

@code {
    bool _isMainLoading;
    bool _isLoading;

    bool _isCustomer = true;

    List<CustomerVendorViewDto> _customerVendorList = [];
    MetaData _metaData = new();
    string? _searchTerm;
    readonly int _pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        _isMainLoading = true;
        StateHasChanged();

        await GetCustomerVendorData();

        _isMainLoading = false;
        StateHasChanged();
    }

    async Task ChangeSearchValue(string value)
    {
        _searchTerm = value;
        await GetCustomerVendorData();
    }

    async Task ChangePage(int page)
    {
        _metaData.CurrentPage = page;
        await GetCustomerVendorData();
    }

    async Task GetCustomerVendorData(bool isCustomer = true)
    {
        _isLoading = true;
        StateHasChanged();

        var result = isCustomer
            ? await HttpRepo.GetAllCustomers(
                new CustomerVendorParameter { PageSize = _pageSize, PageNumber = _metaData.CurrentPage, SearchTerm = _searchTerm })
            : await HttpRepo.GetAllVendors(
                new CustomerVendorParameter { PageSize = _pageSize, PageNumber = _metaData.CurrentPage, SearchTerm = _searchTerm });

        if (result.isSuccess)
        {
            _customerVendorList = result.customerVendorViewDtos!.Items!;
            _metaData = result.customerVendorViewDtos!.MetaData!;
        }

        _isLoading = false;
        StateHasChanged();
    }

    async Task OpenCustomerVendorCreateDialog()
    {
        var options = new DialogOptions();
        var parameters = new DialogParameters<CustomerVendorCreateDialog>
        {
            { x => x.IsCustomer, _isCustomer }
        };
        var dialog = await DialogService.ShowAsync<CustomerVendorCreateDialog>(
            _isCustomer ? "ဈေးဝယ်သူအသစ်၏ ကိုယ်ရေးအချက်အလက်များ" : "ဈေးရောင်းသူအသစ်၏ ကိုယ်ရေးအချက်အလက်များ", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await GetCustomerVendorData(_isCustomer);
        }
    }

    async Task OpenCustomerVendorUpdateDialog(CustomerVendorViewDto customerVendorView)
    {
        var options = new DialogOptions();
        var parameters = new DialogParameters<CustomerVendorUpdateDialog>
        {
            { x => x.IsCustomer, _isCustomer },
            { x => x.Guid, customerVendorView.Guid },
            { x => x.Code, customerVendorView.Code },
            { x => x.Name, customerVendorView.Name },
            { x => x.Phone, customerVendorView.Phone },
            { x => x.Email, customerVendorView.Email },
            { x => x.Address, customerVendorView.Address },
            { x => x.TotalCreditDebit, customerVendorView.TotalCreditDebitLeft }
        };
        var dialog = await DialogService.ShowAsync<CustomerVendorUpdateDialog>(
            _isCustomer ? "ဈေးဝယ်သူ၏ ကိုယ်ရေးအချက်အလက်များ" : "ဈေးရောင်းသူ၏ ကိုယ်ရေးအချက်အလက်များ",
            parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await GetCustomerVendorData(_isCustomer);
        }
    }

    async Task ChangeTab(bool isCustomer = true)
    {
        _isCustomer = isCustomer;
        _searchTerm = null;
        await GetCustomerVendorData(isCustomer);
    }

}