@using Friday.ERP.Shared.DataTransferObjects
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="ဘောင်ချာနံပါတ်" SecondText="@InvoiceNo"/>
            <CustomLabelAndLabel FirstText="စျေးဝယ်သူ" SecondText="@(CustomerName ?? "Walk-in")"/>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="ကျသင့်‌ငွေ" SecondText="@($"{SubTotal.ToString()} ကျပ်")"/>
            @* Todo *@
            <CustomLabelAndInput FirstText="လျော့စျေး">
                <MudItem sm="3" md="3" Class="align-self-center">
                    <MudSelect T="string"
                               Value="@_selectedDiscountType"
                               ValueChanged="DiscountTypeValueChanged"
                               FullWidth="true"
                               Margin="Margin.Dense"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("ကျပ်")"/>
                        <MudSelectItem Value="@("%")"/>
                    </MudSelect>
                </MudItem>
                <MudItem sm="4" md="4" Class="align-self-center">
                    <MudTextField T="long"
                                  Value="@_discount"
                                  ValueChanged="@(e => DiscountOrDeliveryFeesValueChanged(e, true))"
                                  Immediate="true"
                                  FullWidth="true"
                                  Margin="Margin.Dense"
                                  Variant="Variant.Outlined"/>
                </MudItem>
            </CustomLabelAndInput>
            <CustomLabelAndLongField FirstText="လုပ်သားခ"
                                     BindValue="@DeliveryFees" BindValueChanged="@(e => DiscountOrDeliveryFeesValueChanged(e, false))"/>

        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="စုစုပေါင်းကျငွေ" SecondText="@($"{Total.ToString()} ကျပ်")"/>
            @if (CustomerName is not null)
            {
                <CustomLabelAndLabel FirstText="အကြွေး/ပိုငွေ"
                                     SecondTextColor="@(CustomerExistingCreditDebit < 0 ? Color.Error : Color.Info)"
                                     SecondText="@_customerExistingCreditDebitString"/>
            }
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            @if (CustomerName is not null)
            {
                <CustomLabelAndLabel FirstText="ပေးရန်စုစုပေါင်း" SecondText="@($"{GrandTotal.ToString()} ကျပ်")"/>
                <CustomLabelAndLongField
                    FirstText="ပေးငွေစုစုပေါင်း" BindValue="@PaidTotal" BindValueChanged="@TotalPaidValueChanged" Required="true"/>
            }
        </MudGrid>
        @if (CustomerName is not null)
        {
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText="လက်ကျန် အကြွေး/ပိုငွေ"
                                     SecondText="@_totalCreditDebitLeftString"
                                     SecondTextColor="@(CreditDebitLeftTransaction < 0 ? Color.Error : Color.Info)"/>
            </MudGrid>
        }
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndInput FirstText="မှတ်ချက်">
                <MudItem sm="7" md="7" Class="align-self-center">
                    <MudTextField T="string" @bind-Value="Remark"
                                  FullWidth="true" InputType="InputType.Text"
                                  Margin="Margin.Dense" Variant="Variant.Outlined"/>
                </MudItem>
            </CustomLabelAndInput>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="mt-4"/>
    </DialogContent>
    <DialogActions>
        <CustomButton
            Label="ထွက်မည်" OnClick="@Cancel" Color="Color.Default" Variant="Variant.Text" FullWidth="false"/>
        <CustomButton
            Label="ရောင်းမည်" OnClick="@Submit" Variant="Variant.Text" FullWidth="false"/>
    </DialogActions>
</MudDialog>

@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public string? InvoiceNo { get; set; }
    [Parameter] public string? CustomerName { get; set; }
    [Parameter] public long CustomerExistingCreditDebit { get; set; }
    [Parameter] public long SubTotal { get; set; }

    [Parameter] public long Discount { get; set; }
    [Parameter] public long DeliveryFees { get; set; }
    [Parameter] public long Total { get; set; }
    [Parameter] public long GrandTotal { get; set; }
    [Parameter] public long PaidTotal { get; set; }
    [Parameter] public long CreditDebitLeftTransaction { get; set; }
    [Parameter] public string? Remark { get; set; }
    [Parameter] public bool IsUpdate { get; set; }

    string? _customerExistingCreditDebitString;
    string? _totalCreditDebitLeftString = "0 ကျပ်";
    string? _selectedDiscountType = "ကျပ်";

    long _discount;
    long _originalPaidAmount;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _customerExistingCreditDebitString = CustomerExistingCreditDebit.ToString();
        if (CustomerExistingCreditDebit < 0)
            _customerExistingCreditDebitString += " ကျပ် (အကြွေး)";
        else if (CustomerExistingCreditDebit == 0)
            _customerExistingCreditDebitString += " ကျပ်";
        else
            _customerExistingCreditDebitString += " ကျပ် (ပိုငွေ)";

        _discount = Discount;

        if (IsUpdate)
        {
            Total = Total;
            GrandTotal = GrandTotal;
            PaidTotal = PaidTotal;
            _originalPaidAmount = PaidTotal;
        }
        else
        {
            Total = SubTotal;
            GrandTotal = Total - CustomerExistingCreditDebit;

            if (CustomerName is null)
            {
                PaidTotal = GrandTotal;
            }
        }

        CalculateCreditDebit(PaidTotal);
        StateHasChanged();
    }

    void DiscountTypeValueChanged(string value)
    {
        _selectedDiscountType = value;
        DiscountOrDeliveryFeesValueChanged(0, true);
    }

    void DiscountOrDeliveryFeesValueChanged(long value, bool isDiscountField)
    {
        if (isDiscountField)
        {
            _discount = value;
        }
        else
        {
            DeliveryFees = value;
        }

        if (_selectedDiscountType == "ကျပ်")
        {
            Discount = _discount;
        }
        else
        {
            var discountPercent = (double)_discount / 100;
            var calculatedDiscount = SubTotal - SubTotal * discountPercent;
            calculatedDiscount = SubTotal - calculatedDiscount;
            Discount = (long)calculatedDiscount;
        }

        Total = SubTotal + DeliveryFees - Convert.ToInt64(Discount);
        GrandTotal = Total - CustomerExistingCreditDebit;

        if (CustomerName is null)
        {
            PaidTotal = GrandTotal;
        }

        CalculateCreditDebit(PaidTotal);
        StateHasChanged();
    }

    void TotalPaidValueChanged(long value)
    {
        PaidTotal = value;

        if (CustomerName is null)
        {
            PaidTotal = GrandTotal;
        }

        CalculateCreditDebit(PaidTotal);
        StateHasChanged();
    }

    void CalculateCreditDebit(long longValue)
    {
        CreditDebitLeftTransaction = longValue - GrandTotal;
        _totalCreditDebitLeftString = CreditDebitLeftTransaction.ToString();
        if (CreditDebitLeftTransaction < 0)
            _totalCreditDebitLeftString += " ကျပ် (အကြွေး)";
        else if (CreditDebitLeftTransaction == 0)
            _totalCreditDebitLeftString += " ကျပ်";
        else
            _totalCreditDebitLeftString += " ကျပ် (ပိုငွေ)";
    }

    void Cancel()
    {
        MudDialog!.Cancel();
    }

    void Submit()
    {
        if (IsUpdate)
        {
            if (CreditDebitLeftTransaction < 0)
            {
                Snackbar.Add($"ပေးချေပြီး ငွေ {_originalPaidAmount} ကျပ်ထက်လျော့ပေး၍မရပါ", Severity.Error);
                return;
            }
        }

        var dataToReturn = new InvoiceSalePreCreateDto(
            Discount,
            DeliveryFees,
            Total,
            GrandTotal,
            PaidTotal,
            CustomerExistingCreditDebit,
            CreditDebitLeftTransaction,
            Remark
        );
        MudDialog!.Close(DialogResult.Ok(dataToReturn));
    }

}