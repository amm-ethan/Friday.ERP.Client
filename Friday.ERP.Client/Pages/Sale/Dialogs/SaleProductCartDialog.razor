@using Friday.ERP.Shared.DataTransferObjects
@using Friday.ERP.Client.Data
@using Friday.ERP.Client.Pages.Sale.Dialogs.Components.Molecules
@inject IHttpRepository HttpRepo
@inject ISnackbar Snackbar

<CustomDialog IsLoading="@_isMainLoading">
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="2">
                <MudItem sm="12" md="12">
                    <ImageHolder ImageSrc="@(Image is not null ? $"data:image/png;base64, {Image!}" : "product_png/placeholder.png")"
                                 ProductName="@Name" ProductCode="@Code" ProductTotalStock="@Stock.ToString()"/>
                </MudItem>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="mb-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndInput FirstText="ရောင်းစျေး">
                    <MudItem sm="7" md="7" Class="align-self-center">
                        <MudSelect
                            T="long"
                            @ref="PriceSelect"
                            ValueChanged="@(e => ValueChangedPrice(e))"
                            Margin="Margin.Dense" Dense="true"
                            Variant="Variant.Outlined">
                            @foreach (var price in _oldPrices)
                            {
                                var label = $"{price.SalePrice} ကျပ်";
                                if (price.IsWholeSale is true)
                                {
                                    label += " (လက်ကား)";
                                }

                                <MudSelectItem Value="@(price.SalePrice)">
                                    @label
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </CustomLabelAndInput>
                <CustomLabelAndInput FirstText="နှုန်း">
                    <MudItem sm="7" md="7" Class="align-self-center">
                        <MudTextField
                            @ref="QuantityTextField"
                            T="int" Required="true"
                            ValueChanged="@ValueChangedQuantity"
                            Immediate="true"
                            FullWidth="true" InputType="InputType.Number"
                            Margin="Margin.Dense" Variant="Variant.Outlined"/>
                    </MudItem>
                </CustomLabelAndInput>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText="စုစုပေါင်း" SecondText="@($"{TotalPrice} ကျပ်")"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="mt-4"/>
        </DialogContent>
        <DialogActions>
            @if (IsUpdate)
            {
                <CustomButton
                    Label="စျေးခြင်းထဲ့မှဖယ်ရန်" OnClick="@Delete" Color="Color.Error" Variant="Variant.Text" FullWidth="false"/>
            }
            <CustomButton
                Label="ထွက်မည်" OnClick="@Cancel" Color="Color.Default" Variant="Variant.Text" FullWidth="false"/>
            <CustomButton
                Label="စျေးခြင်းထဲ့ထည့်ရန်" OnClick="@Submit" Variant="Variant.Text" FullWidth="false"/>
        </DialogActions>
    </MudDialog>
</CustomDialog>

@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public bool IsUpdate { get; set; }

    [Parameter] public Guid Guid { get; set; }
    [Parameter] public string? Image { get; set; }
    [Parameter] public string? Code { get; set; }
    [Parameter] public string? Name { get; set; }
    [Parameter] public int Stock { get; set; }

    [Parameter] public Guid SelectedPriceGuid { get; set; }
    [Parameter] public long SelectedPrice { get; set; }
    [Parameter] public bool SelectedPriceIsWholeSale { get; set; }

    [Parameter] public int Quantity { get; set; } = 1;
    [Parameter] public long TotalPrice { get; set; }

    bool _isMainLoading;
    List<ProductPriceViewDto> _oldPrices = [];

    MudSelect<long> PriceSelect { get; set; } = new();
    MudTextField<int> QuantityTextField { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        QuantityTextField.Text = Quantity.ToString();
        QuantityTextField.Value = Quantity;

        if (IsUpdate)
        {
            var label = $"{SelectedPrice} ကျပ်";
            if (SelectedPriceIsWholeSale)
            {
                label += " (လက်ကား)";
            }

            PriceSelect.Text = label;
            PriceSelect.Value = SelectedPrice;
        }
        else
        {
            await PriceSelect.Clear();
        }
    }

    void ValueChangedQuantity(int value)
    {
        Quantity = value;
        TotalPrice = Quantity * SelectedPrice;
        StateHasChanged();
    }

    void ValueChangedPrice(long value)
    {
        SelectedPriceGuid = _oldPrices
            .Where(c => c.SalePrice == value)
            .Select(c => c.Guid)
            .SingleOrDefault();

        SelectedPriceIsWholeSale = _oldPrices
            .Where(c => c.SalePrice == value)
            .Select(c => c.IsWholeSale)
            .SingleOrDefault() ?? false;

        SelectedPrice = value;
        TotalPrice = Quantity * SelectedPrice;
        StateHasChanged();
    }

    void Cancel()
    {
        MudDialog!.Cancel();
    }

    void Delete()
    {
        MudDialog!.Close(DialogResult.Ok(Guid));
    }

    void Submit()
    {
        if (TotalPrice == 0)
        {
            Snackbar.Add("စျေးနှုန်းထည့်ပါ", Severity.Error);
            return;
        }

        if (Quantity > Stock)
        {
            Snackbar.Add("လက်ကျန်ထက်ပိုဝယ်၍မရပါ", Severity.Error);
            return;
        }

        MudDialog!.Close(DialogResult.Ok(new ProductSaleAddToCartViewDto
        {
            ProductGuid = Guid,
            Image = Image,
            Code = Code,
            Name = Name,
            Stock = Stock,
            SalePrice = SelectedPrice,
            SalePriceGuid = SelectedPriceGuid,
            SalePriceIsWholeSale = SelectedPriceIsWholeSale,
            Quantity = Quantity,
            TotalPrice = TotalPrice
        }));
    }

    protected override async Task OnInitializedAsync()
    {
        _isMainLoading = true;
        StateHasChanged();

        await GetProductPrices();
        _isMainLoading = false;
        StateHasChanged();
    }

    async Task GetProductPrices()
    {
        var result = await HttpRepo.GetProductPriceHistory(Guid);
        if (result.isSuccess)
        {
            _oldPrices = result.productPriceViewDtos!;
        }
    }

}