@using Friday.ERP.Client.Data
@using Friday.ERP.Client.Pages.Sale.Dialogs.Components.Molecules
@using Friday.ERP.Shared.DataTransferObjects
@inject IHttpRepository HttpRepo
@inject ISnackbar Snackbar

<CustomDialog IsLoading="@_isMainLoading">
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="2">
                <MudItem sm="12" md="12">
                    <ImageHolder ImageSrc="@(Image is not null ? $"data:image/png;base64, {Image!}" : "product_png/placeholder.png")"
                                 ProductName="@Name" ProductCode="@Code" ProductTotalStock="@Stock.ToString()"/>
                </MudItem>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="mt-4 mb-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText="အရင်ဝယ်စျေး" SecondText="@($"{_lastPrice.ToString()} ကျပ်")"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLongField
                    FirstText="ဝယ်စျေး" BindValue="@Price" BindValueChanged="@ValueChangedPrice" Required="true"/>
                <CustomLabelAndLongField
                    FirstText="ခု" BindValue="@Quantity" BindValueChanged="@ValueChangedQuantity" Required="true"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLabel FirstText="စုစုပေါင်း" SecondText="@($"{TotalPrice} ကျပ်")"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="mt-4"/>
        </DialogContent>
        <DialogActions>
            @if (IsUpdate)
            {
                <CustomButton
                    Label="စျေးခြင်းထဲ့မှဖယ်ရန်" OnClick="@Delete" Color="Color.Error" Variant="Variant.Text" FullWidth="false"/>
            }
            <CustomButton
                Label="ထွက်မည်" OnClick="@Cancel" Color="Color.Default" Variant="Variant.Text" FullWidth="false"/>

            <CustomButton
                Label=@("စျေးခြင်းထဲ့ထည့်ရန်") OnClick="@Submit" Variant="Variant.Text" FullWidth="false"/>
        </DialogActions>
    </MudDialog>
</CustomDialog>

@code {

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public bool IsUpdate { get; set; }

    [Parameter] public Guid Guid { get; set; }
    [Parameter] public string? Image { get; set; }
    [Parameter] public string? Code { get; set; }
    [Parameter] public string? Name { get; set; }
    [Parameter] public int Stock { get; set; }

    [Parameter] public long Price { get; set; }
    [Parameter] public long Quantity { get; set; } = 1;
    [Parameter] public long TotalPrice { get; set; }

    bool _isMainLoading;
    long? _lastPrice;

    protected override async Task OnInitializedAsync()
    {
        _isMainLoading = true;
        StateHasChanged();

        var result = await HttpRepo.GetLastPurchasedPriceOfProduct(Guid);
        if (result.isSuccess)
        {
            _lastPrice = result!.productPurchasePriceViewDto!.BuyPrice;
        }

        _isMainLoading = false;
        StateHasChanged();
    }

    void ValueChangedQuantity(long value)
    {
        Quantity = value;
        TotalPrice = Quantity * Price;
        StateHasChanged();
    }

    void ValueChangedPrice(long value)
    {
        Price = value;
        TotalPrice = Quantity * Price;
        StateHasChanged();
    }

    void Submit()
    {
        if (TotalPrice == 0)
        {
            Snackbar.Add("စျေးနှုန်းထည့်ပါ", Severity.Error);
        }
        else
        {
            MudDialog!.Close(DialogResult.Ok(new ProductPurchaseAddToCartViewDto
            {
                ProductGuid = Guid,
                Image = Image,
                Code = Code,
                Name = Name,
                Stock = Stock,
                BuyPrice = Price,
                Quantity = (int)Quantity,
                TotalPrice = TotalPrice
            }));
        }
    }

    void Delete()
    {
        MudDialog!.Close(DialogResult.Ok(Guid));
    }

    void Cancel()
    {
        MudDialog!.Cancel();
    }

}