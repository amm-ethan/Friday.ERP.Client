@page "/Settings"
@using Friday.ERP.Shared.DataTransferObjects
@using Friday.ERP.Client.Data
@using Friday.ERP.Client.Shared.Layouts
@inject IHttpRepository HttpRepo
@inject ISnackbar Snackbar

@layout MainLayout
@attribute [Authorize]

<CustomContainer>
    <CustomPage Sm="12" Md="6" IsLoading="@_isMainLoading">
        <MudGrid Spacing="2">
            <MudItem sm="12" md="12" Class="align-self-center">
                <MudText Typo="Typo.h6">
                    ဆိုင်အကြောင်း
                </MudText>
            </MudItem>
        </MudGrid>
        <MudGrid Spacing="2">
            <MudItem sm="12" md="12" Class="d-flex justify-center">
                <MudImage Src="@ShopImage" Width="100" Height="100" Elevation="0"/>
            </MudItem>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="ဆိုင်အမည်" SecondText="@ShopName"/>
        </MudGrid>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="ဆိုင်ဖော်ပြချက်" SecondText="@ShopDescription"/>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="လိပ်စာ ၁" SecondText="@AddressOne"/>
            <CustomLabelAndLabel FirstText="လိပ်စာ ၂" SecondText="@AddressTwo"/>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
        <MudGrid Spacing="2">
            <CustomLabelAndLabel FirstText="ဖုန်း ၁" SecondText="@PhoneOne"/>
            <CustomLabelAndLabel FirstText="ဖုန်း ၂" SecondText="@PhoneTwo"/>
            <CustomLabelAndLabel FirstText="ဖုန်း ၃" SecondText="@PhoneThree"/>
            <CustomLabelAndLabel FirstText="ဖုန်း ၄" SecondText="@PhoneFour"/>
        </MudGrid>
        <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
    </CustomPage>
    <CustomPage Sm="12" Md="6" IsLoading="@_isMainLoading">
        <MudGrid Spacing="2">
            <MudItem sm="12" md="12" Class="align-self-center">
                <MudText Typo="Typo.h6">
                    ဆက်တင်များ
                </MudText>
            </MudItem>
        </MudGrid>
        <MudForm @ref="_form" @bind-IsValid="@_success" @bind-Errors="@_errors">
            <MudGrid Spacing="2">
                <CustomLabelAndLongField FirstText="အမြတ်ရာခိုင်နှုန်း"
                                         @bind-BindValue="@DefaultProfitPercent"/>
                <CustomLabelAndLongField FirstText="အမြတ်ရာခိုင်နှုန်း (လက်ကားစျေး)"
                                         @bind-BindValue="@DefaultProfitPercentForWholeSale"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLabelAndLongField FirstText="အနည်းဆုံး ပစ္စည်းလက်ကျန်"
                                         @bind-BindValue="@MinimumStockMargin"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2">
                <CustomLableAndCheckbox FirstText="ရောင်းစျေး အကြံပေးရန်" @bind-BindValue="SuggestSalePrice"/>
            </MudGrid>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-4"/>
            <MudGrid Spacing="2" Class="flex-grow-1">
                <MudItem sm="12" md="12">
                    <CustomButton
                        Label="သိမ်းရန်" IsLoading="_isLoading" OnClick="@Update" Variant="Variant.Filled"/>
                </MudItem>
            </MudGrid>
        </MudForm>
    </CustomPage>
</CustomContainer>

@code {
    MudForm? _form;
    bool _success;
    string[] _errors = [];

    bool _isMainLoading;
    bool _isLoading;

    string? ShopImage { get; set; }
    string? ShopName { get; set; }
    string? ShopDescription { get; set; }
    string? AddressOne { get; set; }
    string? AddressTwo { get; set; }
    string? PhoneOne { get; set; }
    string? PhoneTwo { get; set; }
    string? PhoneThree { get; set; }
    string? PhoneFour { get; set; }

    long DefaultProfitPercent { get; set; }
    long DefaultProfitPercentForWholeSale { get; set; }
    long MinimumStockMargin { get; set; }
    bool SuggestSalePrice { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _isMainLoading = true;
        StateHasChanged();

        var result = await HttpRepo.GetSettings();
        if (result.isSuccess)
        {
            BindData(result.settingViewDto!);
        }

        _isMainLoading = false;
        StateHasChanged();
    }

    async Task Update()
    {
        _isLoading = true;
        StateHasChanged();

        await _form!.Validate();
        if (_form.IsValid)
        {
            var result = await HttpRepo.UpdateSettings(new SettingUpdateDto(
                    (int)DefaultProfitPercent,
                    (int)DefaultProfitPercentForWholeSale,
                    (int)MinimumStockMargin,
                    SuggestSalePrice
                )
            );
            if (result.isSuccess)
            {
                BindData(result.settingViewDto!);
                Snackbar.Add("ပြောင်းလဲခြင်းအောင်မြင်သည်။", Severity.Success);
            }
        }

        _isLoading = false;
        StateHasChanged();
    }

    void BindData(SettingViewDto settingViewDto)
    {
        if (settingViewDto.ShopImage is not null)
            ShopImage = $"data:image/png;base64, {settingViewDto.ShopImage!}";

        ShopName = settingViewDto.ShopName;
        ShopDescription = settingViewDto.ShopDescription;
        AddressOne = settingViewDto.AddressOne;
        AddressTwo = settingViewDto.AddressTwo;
        PhoneOne = settingViewDto.PhoneOne;
        PhoneTwo = settingViewDto.PhoneTwo;
        PhoneThree = settingViewDto.PhoneThree;
        PhoneFour = settingViewDto.PhoneFour;

        DefaultProfitPercent = settingViewDto.DefaultProfitPercent;
        DefaultProfitPercentForWholeSale = settingViewDto.DefaultProfitPercentForWholeSale;
        MinimumStockMargin = settingViewDto.MinimumStockMargin;
        SuggestSalePrice = settingViewDto.SuggestSalePrice ?? false;
        StateHasChanged();
    }

}